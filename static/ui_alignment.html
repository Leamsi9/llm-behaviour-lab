<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Alignment Testing Lab - LLM Behavior Lab</title>
  <script src="/static/tailwind.min.js"></script>
  <script src="/static/chart.min.js"></script>
  <style>
    .model-output {
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .alignment-score {
      position: relative;
    }

    .alignment-score::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: linear-gradient(90deg, #ef4444 0%, #f59e0b 50%, #10b981 100%);
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .score-high {
      background: linear-gradient(90deg, #10b981, #059669);
    }

    .score-medium {
      background: linear-gradient(90deg, #f59e0b, #d97706);
    }

    .score-low {
      background: linear-gradient(90deg, #ef4444, #dc2626);
    }
  </style>
</head>

<body class="bg-gray-50 p-4">
  <div class="max-w-7xl mx-auto space-y-6">

    <!-- Header -->
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">Alignment Testing Lab</h1>
          <p class="text-gray-600 mt-2">Measure how prompt injections and tool integrations affect response alignment
          </p>
        </div>
        <div id="connectionStatus" class="px-4 py-2 rounded-full bg-gray-200 text-gray-700">Connecting…</div>
      </div>

      <!-- Alignment Summary -->
      <div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-blue-50 p-4 rounded-lg">
          <div class="text-sm text-blue-600 font-medium">Avg Goal Adherence</div>
          <div id="avgGoalAdherence" class="text-2xl font-bold text-blue-900">0.00</div>
        </div>
        <div class="bg-green-50 p-4 rounded-lg">
          <div class="text-sm text-green-600 font-medium">Avg Consistency</div>
          <div id="avgConsistency" class="text-2xl font-bold text-green-900">0.00</div>
        </div>
        <div class="bg-purple-50 p-4 rounded-lg">
          <div class="text-sm text-purple-600 font-medium">Avg Relevance</div>
          <div id="avgRelevance" class="text-2xl font-bold text-purple-900">0.00</div>
        </div>
        <div class="bg-red-50 p-4 rounded-lg">
          <div class="text-sm text-red-600 font-medium">Misalignment Issues</div>
          <div id="misalignmentCount" class="text-2xl font-bold text-red-900">0</div>
        </div>
      </div>
    </div>

    <!-- Test Configuration -->
    <div class="bg-white rounded-lg shadow p-6 space-y-6">

      <!-- Model Selection -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Model Selection</label>
        <select id="modelSelect" class="w-full p-2 border rounded">
          <option>Loading models…</option>
        </select>
      </div>

      <!-- Prompt Configuration -->
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">System Prompt</label>
          <textarea id="systemPrompt" class="w-full p-2 border rounded h-20"
            placeholder="You are a helpful assistant."></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">User Prompt</label>
          <textarea id="userPrompt" class="w-full p-2 border rounded h-24"
            placeholder="Explain quantum computing in simple terms."></textarea>
        </div>
      </div>

      <!-- Model Parameters -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Temperature</label>
          <input type="range" id="temperature" min="0" max="2" step="0.05" value="0.7" class="w-full" />
          <div class="text-xs text-gray-600 mt-1">Value: <span id="tempValue">0.7</span></div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Max Tokens</label>
          <input type="number" id="maxTokens" min="1" max="4096" value="512" class="w-full p-2 border rounded" />
        </div>
      </div>

      <!-- Independent Variables (Prompt Injection & Tools) -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

        <!-- Prompt Injection -->
        <div class="space-y-3">
          <h3 class="text-lg font-semibold text-gray-900">Prompt Injection</h3>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Injection Type</label>
            <select id="injectionType" class="w-full p-2 border rounded">
              <option value="none">None</option>
              <option value="system_modification">System Modification</option>
              <option value="user_augmentation">User Augmentation</option>
              <option value="context_injection">Context Injection</option>
              <option value="cot_instruction">CoT Instructions</option>
            </select>
          </div>
          <div id="injectionParams" class="hidden space-y-2">
            <div>
              <label class="block text-sm text-gray-600">Modification Type</label>
              <select id="modificationType" class="w-full p-2 border rounded text-sm">
                <option value="concise">Concise</option>
                <option value="detailed">Detailed</option>
                <option value="creative">Creative</option>
                <option value="factual">Factual</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Tool Integration -->
        <div class="space-y-3">
          <h3 class="text-lg font-semibold text-gray-900">Tool Integration</h3>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Integration Method</label>
            <select id="toolMethod" class="w-full p-2 border rounded">
              <option value="none">None</option>
              <option value="direct_insertion">Direct Insertion</option>
              <option value="summarized_insertion">Summarized Insertion</option>
              <option value="filtered_insertion">Filtered Insertion</option>
              <option value="staged_insertion">Staged Insertion</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Test Controls -->
      <div class="flex gap-4 pt-4 border-t">
        <button id="runTest" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 font-medium">
          Run Alignment Test
        </button>
        <button id="stopTest" class="bg-red-600 text-white px-6 py-2 rounded hover:bg-red-700 font-medium" disabled>
          Stop Test
        </button>
        <button id="clearResults" class="bg-gray-200 text-gray-800 px-6 py-2 rounded hover:bg-gray-300">
          Clear Results
        </button>
        <button id="exportData" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">
          Export Data
        </button>
      </div>
    </div>

    <!-- Results Display -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

      <!-- Alignment Metrics -->
      <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-xl font-semibold text-gray-900 mb-4">Alignment Scores</h3>

        <div class="space-y-4">
          <!-- Individual Scores -->
          <div>
            <div class="flex justify-between text-sm mb-2">
              <span>Goal Adherence</span>
              <span id="goalAdherenceScore">0.00</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3">
              <div id="goalAdherenceBar" class="alignment-score score-low h-3 rounded-full" style="width: 0%"></div>
            </div>
          </div>

          <div>
            <div class="flex justify-between text-sm mb-2">
              <span>Consistency</span>
              <span id="consistencyScore">0.00</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3">
              <div id="consistencyBar" class="alignment-score score-low h-3 rounded-full" style="width: 0%"></div>
            </div>
          </div>

          <div>
            <div class="flex justify-between text-sm mb-2">
              <span>Relevance</span>
              <span id="relevanceScore">0.00</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3">
              <div id="relevanceBar" class="alignment-score score-low h-3 rounded-full" style="width: 0%"></div>
            </div>
          </div>

          <div>
            <div class="flex justify-between text-sm mb-2">
              <span>Factual Accuracy</span>
              <span id="factualScore">0.00</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3">
              <div id="factualBar" class="alignment-score score-low h-3 rounded-full" style="width: 0%"></div>
            </div>
          </div>

          <!-- Risk Scores -->
          <div class="mt-6 space-y-2">
            <div class="flex justify-between text-sm">
              <span class="text-red-600">Hallucination Risk</span>
              <span id="hallucinationScore" class="text-red-600">0.00</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-orange-600">Injection Bleed</span>
              <span id="injectionBleedScore" class="text-orange-600">0.00</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-purple-600">Tool Interference</span>
              <span id="toolInterferenceScore" class="text-purple-600">0.00</span>
            </div>
          </div>
        </div>

        <!-- Alignment Trends Chart -->
        <div class="mt-6">
          <canvas id="alignmentChart" width="400" height="200"></canvas>
        </div>
      </div>

      <!-- Analysis Results -->
      <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-xl font-semibold text-gray-900 mb-4">Analysis Results</h3>

        <div class="space-y-4">
          <div>
            <div class="text-sm text-gray-600 mb-1">Strategy</div>
            <div id="analysisStrategy" class="font-medium">-</div>
          </div>

          <div>
            <div class="text-sm text-gray-600 mb-1">Overall Assessment</div>
            <div id="overallAssessment" class="p-3 bg-gray-50 rounded text-sm">-</div>
          </div>

          <div>
            <div class="text-sm text-gray-600 mb-1">Detected Issues</div>
            <div id="detectedIssues" class="space-y-1">
              <div class="text-sm text-gray-500">No issues detected</div>
            </div>
          </div>

          <div>
            <div class="text-sm text-gray-600 mb-1">Analysis Notes</div>
            <div id="analysisNotes" class="p-3 bg-blue-50 rounded text-sm text-blue-800">-</div>
          </div>

          <!-- Modification Impact -->
          <div class="mt-6 p-4 bg-yellow-50 rounded">
            <h4 class="font-medium text-yellow-900 mb-2">Alignment Impact Analysis</h4>
            <div id="alignmentImpact" class="text-sm text-yellow-800">Run a test to see alignment impact analysis.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Response Output -->
    <div class="bg-white rounded-lg shadow p-6">
      <h3 class="text-xl font-semibold text-gray-900 mb-4">Response Output</h3>
      <div id="responseOutput" class="model-output bg-gray-50 p-4 rounded min-h-32 border">
        Run a test to see the model response here.
      </div>
    </div>

  </div>

  <script>
    // Elements
    const systemPrompt = document.getElementById('systemPrompt');
    const userPrompt = document.getElementById('userPrompt');
    const modelSelect = document.getElementById('modelSelect');
    const injectionType = document.getElementById('injectionType');
    const modificationType = document.getElementById('modificationType');
    const toolMethod = document.getElementById('toolMethod');
    const injectionParams = document.getElementById('injectionParams');
    const temperature = document.getElementById('temperature');
    const tempValue = document.getElementById('tempValue');
    const maxTokens = document.getElementById('maxTokens');

    const runTest = document.getElementById('runTest');
    const stopTest = document.getElementById('stopTest');
    const clearResults = document.getElementById('clearResults');
    const exportData = document.getElementById('exportData');

    // Summary elements
    const avgGoalAdherence = document.getElementById('avgGoalAdherence');
    const avgConsistency = document.getElementById('avgConsistency');
    const avgRelevance = document.getElementById('avgRelevance');
    const misalignmentCount = document.getElementById('misalignmentCount');

    // Score elements
    const goalAdherenceScore = document.getElementById('goalAdherenceScore');
    const goalAdherenceBar = document.getElementById('goalAdherenceBar');
    const consistencyScore = document.getElementById('consistencyScore');
    const consistencyBar = document.getElementById('consistencyBar');
    const relevanceScore = document.getElementById('relevanceScore');
    const relevanceBar = document.getElementById('relevanceBar');
    const factualScore = document.getElementById('factualScore');
    const factualBar = document.getElementById('factualBar');
    const hallucinationScore = document.getElementById('hallucinationScore');
    const injectionBleedScore = document.getElementById('injectionBleedScore');
    const toolInterferenceScore = document.getElementById('toolInterferenceScore');

    // Analysis elements
    const analysisStrategy = document.getElementById('analysisStrategy');
    const overallAssessment = document.getElementById('overallAssessment');
    const detectedIssues = document.getElementById('detectedIssues');
    const analysisNotes = document.getElementById('analysisNotes');
    const alignmentImpact = document.getElementById('alignmentImpact');
    const responseOutput = document.getElementById('responseOutput');
    const connectionStatus = document.getElementById('connectionStatus');

    // State
    let ws = null;
    let alignmentHistory = [];
    let currentTestResults = null;
    let sessionTests = [];

    // Chart
    let alignmentChart = null;

    // Initialize
    init();

    async function init() {
      await loadModels();
      setupWebSocket();
      setupEventListeners();
      initChart();
    }

    async function loadModels() {
      try {
        const r = await fetch('/api/models');
        const d = await r.json();
        modelSelect.innerHTML = '';
        if (d.models && d.models.length > 0) {
          d.models.forEach(model => {
            const opt = document.createElement('option');
            opt.value = model;
            opt.textContent = model;
            modelSelect.appendChild(opt);
          });
        } else {
          modelSelect.innerHTML = '<option>No models available</option>';
        }
      } catch (e) {
        console.error('Failed to load models:', e);
        modelSelect.innerHTML = '<option>Error loading models</option>';
      }
    }

    function setupWebSocket() {
      ws = new WebSocket(`ws://${location.host}/ws`);

      ws.onopen = () => {
        connectionStatus.textContent = 'Connected';
        connectionStatus.className = 'px-4 py-2 rounded-full bg-green-100 text-green-700';
      };

      ws.onclose = () => {
        connectionStatus.textContent = 'Disconnected';
        connectionStatus.className = 'px-4 py-2 rounded-full bg-red-100 text-red-700';
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.log) {
          // Routing/debug log - display in browser console
          console.log(data.log);
        } else if (data.token && !data.done) {
          // Streaming token
          responseOutput.textContent += data.token;
        } else if (data.done) {
          // Test completed
          handleTestCompletion(data);
        } else if (data.error) {
          alert(`Error: ${data.error}`);
        }
      };
    }

    function setupEventListeners() {
      injectionType.addEventListener('change', () => {
        injectionParams.classList.toggle('hidden', injectionType.value === 'none');
      });

      temperature.addEventListener('input', () => tempValue.textContent = temperature.value);

      runTest.addEventListener('click', runAlignmentTest);
      stopTest.addEventListener('click', stopAlignmentTest);
      clearResults.addEventListener('click', clearAllResults);
      exportData.addEventListener('click', exportSessionData);
    }

    function initChart() {
      const ctx = document.getElementById('alignmentChart').getContext('2d');
      alignmentChart = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: ['Goal Adherence', 'Consistency', 'Relevance', 'Factual Accuracy', 'Coherence', 'Completeness'],
          datasets: [{
            label: 'Current Test',
            data: [0, 0, 0, 0, 0, 0],
            borderColor: 'rgb(59, 130, 246)',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
          }]
        },
        options: {
          responsive: true,
          scales: {
            r: {
              beginAtZero: true,
              max: 1,
              ticks: {
                stepSize: 0.2
              }
            }
          }
        }
      });
    }

    async function runAlignmentTest() {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        alert('WebSocket not connected. Please refresh the page.');
        return;
      }

      // Clear previous results
      responseOutput.textContent = '';
      currentTestResults = null;

      // Prepare payload
      const payload = {
        system: systemPrompt.value,
        user: userPrompt.value,
        model_name: modelSelect.value,
        test_type: 'alignment',
        strategy_name: `${injectionType.value}_${toolMethod.value}`,
        energy_benchmark: "conservative_estimate", // Not used for alignment, but required
        injection_type: injectionType.value,
        injection_params: injectionType.value !== 'none' ? {
          modification_type: modificationType.value
        } : {},
        tool_integration_method: toolMethod.value,
        tool_config: {},
        temp: parseFloat(temperature.value),
        max_tokens: parseInt(maxTokens.value)
      };

      ws.send(JSON.stringify(payload));
      runTest.disabled = true;
      runTest.textContent = 'Running...';
      stopTest.disabled = false;
    }

    function stopAlignmentTest() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ command: 'cancel' }));
        stopTest.disabled = true;
        stopTest.textContent = 'Stopping...';
      }
    }

    function handleTestCompletion(data) {
      runTest.disabled = false;
      runTest.textContent = 'Run Alignment Test';
      stopTest.disabled = true;
      stopTest.textContent = 'Stop Test';

      if (data.error) {
        alert(`Test failed: ${data.error}`);
        return;
      }

      currentTestResults = data;
      sessionTests.push(data);

      // Update alignment display
      updateAlignmentDisplay(data.alignment_metrics);

      // Update analysis display
      updateAnalysisDisplay(data);

      // Update chart
      updateAlignmentChart(data.alignment_metrics);

      // Update session summary
      updateSessionSummary();

      // Analyze modification impact
      analyzeAlignmentImpact(data);
    }

    function updateAlignmentDisplay(alignmentMetrics) {
      // Update individual scores
      updateScoreDisplay('goalAdherence', alignmentMetrics.goal_adherence);
      updateScoreDisplay('consistency', alignmentMetrics.consistency);
      updateScoreDisplay('relevance', alignmentMetrics.relevance);
      updateScoreDisplay('factual', alignmentMetrics.factual_accuracy);

      // Update risk scores
      hallucinationScore.textContent = alignmentMetrics.hallucination_score.toFixed(2);
      injectionBleedScore.textContent = alignmentMetrics.injection_bleed.toFixed(2);
      toolInterferenceScore.textContent = alignmentMetrics.tool_interference.toFixed(2);
    }

    function updateScoreDisplay(metric, score) {
      const scoreElement = document.getElementById(`${metric}Score`);
      const barElement = document.getElementById(`${metric}Bar`);

      scoreElement.textContent = score.toFixed(2);
      barElement.style.width = `${score * 100}%`;

      // Update color based on score
      let scoreClass = 'score-low';
      if (score >= 0.7) scoreClass = 'score-high';
      else if (score >= 0.4) scoreClass = 'score-medium';

      barElement.className = `alignment-score ${scoreClass} h-3 rounded-full`;
    }

    function updateAnalysisDisplay(data) {
      analysisStrategy.textContent = data.strategy || 'Unknown';

      // Overall assessment
      const metrics = data.alignment_metrics;
      const avgScore = (metrics.goal_adherence + metrics.consistency + metrics.relevance + metrics.factual_accuracy) / 4;

      let assessment = 'Poor alignment';
      let bgColor = 'bg-red-50 text-red-800';

      if (avgScore >= 0.8) {
        assessment = 'Excellent alignment';
        bgColor = 'bg-green-50 text-green-800';
      } else if (avgScore >= 0.6) {
        assessment = 'Good alignment';
        bgColor = 'bg-blue-50 text-blue-800';
      } else if (avgScore >= 0.4) {
        assessment = 'Moderate alignment';
        bgColor = 'bg-yellow-50 text-yellow-800';
      }

      overallAssessment.textContent = `${assessment} (${avgScore.toFixed(2)} average score)`;
      overallAssessment.className = `p-3 rounded text-sm ${bgColor}`;

      // Detected issues
      const issues = metrics.detected_issues || [];
      detectedIssues.innerHTML = '';

      if (issues.length > 0) {
        issues.forEach(issue => {
          const issueDiv = document.createElement('div');
          issueDiv.className = 'text-sm text-red-600';
          issueDiv.textContent = `• ${issue.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}`;
          detectedIssues.appendChild(issueDiv);
        });
      } else {
        const noIssuesDiv = document.createElement('div');
        noIssuesDiv.className = 'text-sm text-green-600';
        noIssuesDiv.textContent = 'No significant issues detected';
        detectedIssues.appendChild(noIssuesDiv);
      }

      // Analysis notes
      const notes = metrics.analysis_notes || [];
      analysisNotes.textContent = notes.length > 0 ? notes.join(' ') : 'No specific analysis notes.';
    }

    function updateAlignmentChart(alignmentMetrics) {
      const data = [
        alignmentMetrics.goal_adherence,
        alignmentMetrics.consistency,
        alignmentMetrics.relevance,
        alignmentMetrics.factual_accuracy,
        alignmentMetrics.coherence_score,
        alignmentMetrics.completeness_score
      ];

      alignmentChart.data.datasets[0].data = data;
      alignmentChart.update();
    }

    function analyzeAlignmentImpact(data) {
      const alignmentMetrics = data.alignment_metrics;
      const modInfo = data.modification_info;

      let impactText = '';

      if (alignmentMetrics.injection_bleed > 0.3) {
        impactText += `Prompt injection caused ${alignmentMetrics.injection_bleed.toFixed(2)} bleed effect, potentially reducing response quality. `;
      }

      if (alignmentMetrics.tool_interference > 0.3) {
        impactText += `Tool integration created ${alignmentMetrics.tool_interference.toFixed(2)} interference, possibly disrupting natural response flow. `;
      }

      if (modInfo.injection_overhead > 0) {
        const qualityImpact = alignmentMetrics.injection_bleed * modInfo.injection_overhead;
        impactText += `Injection overhead of ${modInfo.injection_overhead} tokens may have impacted alignment by ${(qualityImpact * 100).toFixed(1)}%. `;
      }

      if (!impactText) {
        impactText = 'Modifications appear to have minimal negative impact on alignment.';
      }

      alignmentImpact.textContent = impactText;
    }

    function updateSessionSummary() {
      if (sessionTests.length === 0) return;

      // Calculate averages
      const avgGoal = sessionTests.reduce((sum, test) => sum + test.alignment_metrics.goal_adherence, 0) / sessionTests.length;
      const avgConsistency = sessionTests.reduce((sum, test) => sum + test.alignment_metrics.consistency, 0) / sessionTests.length;
      const avgRelevance = sessionTests.reduce((sum, test) => sum + test.alignment_metrics.relevance, 0) / sessionTests.length;

      // Count misalignment issues
      const totalIssues = sessionTests.reduce((sum, test) => sum + (test.alignment_metrics.detected_issues?.length || 0), 0);

      avgGoalAdherence.textContent = avgGoal.toFixed(2);
      avgConsistency.textContent = avgConsistency.toFixed(2);
      avgRelevance.textContent = avgRelevance.toFixed(2);
      misalignmentCount.textContent = totalIssues;
    }

    function clearAllResults() {
      responseOutput.textContent = 'Run a test to see the model response here.';

      // Reset scores
      ['goalAdherence', 'consistency', 'relevance', 'factual'].forEach(metric => {
        document.getElementById(`${metric}Score`).textContent = '0.00';
        document.getElementById(`${metric}Bar`).style.width = '0%';
      });

      hallucinationScore.textContent = '0.00';
      injectionBleedScore.textContent = '0.00';
      toolInterferenceScore.textContent = '0.00';

      // Reset analysis
      analysisStrategy.textContent = '-';
      overallAssessment.textContent = '-';
      detectedIssues.innerHTML = '<div class="text-sm text-gray-500">No issues detected</div>';
      analysisNotes.textContent = '-';
      alignmentImpact.textContent = 'Run a test to see alignment impact analysis.';

      // Reset chart
      alignmentChart.data.datasets[0].data = [0, 0, 0, 0, 0, 0];
      alignmentChart.update();

      // Reset session
      sessionTests = [];
      updateSessionSummary();
    }

    async function exportSessionData() {
      try {
        const r = await fetch('/api/export-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ filepath: 'alignment_test_session.json' })
        });

        if (r.ok) {
          alert('Session data exported to alignment_test_session.json');
        } else {
          alert('Export failed');
        }
      } catch (e) {
        alert('Export error: ' + e.message);
      }
    }
  </script>
</body>

</html>